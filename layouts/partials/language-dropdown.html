{{- $translations := .Translations -}}
{{- $languageCount := add (len $translations) 1 -}}
{{- $siteHasMultipleLanguages := gt (len $.Site.Languages) 1 -}}

{{- if or (gt $languageCount 1) $siteHasMultipleLanguages -}}
<div class="language-dropdown">
  <button
    class="language-toggle"
    aria-label="{{ i18n "lang_select_title" }}"
    aria-expanded="false"
    aria-haspopup="true"
  >
    <div class="language-icon">
      <svg width="20" height="20" aria-hidden="true">
        <use href="/img/svg/sprite.svg#icon-language"></use>
      </svg>
    </div>
  </button>

  <div class="language-panel" hidden>
    <div class="language-list">
      {{- range .Translations -}}
        <a
          href="{{ .RelPermalink }}"
          class="language-option"
          lang="{{ .Language.Lang }}"
          hreflang="{{ .Language.Lang }}"
        >
          <span class="language-radio" aria-hidden="true"></span>
          <span class="language-name">{{ .Language.LanguageName }}</span>
        </a>
      {{- end -}}

      {{- /* Current language (shown but not clickable) */ -}}
      <span class="language-option language-option--current" aria-current="true">
        <span class="language-radio" aria-hidden="true"></span>
        <span class="language-name">{{ .Language.LanguageName }}</span>
      </span>

      {{- /* Fallback languages - shown only if current page has no translation */ -}}
      {{- if eq (len $translations) 0 -}}
        {{- $is404 := eq .Kind "404" -}}
        {{- range $.Site.Languages -}}
          {{- if ne .Lang $.Language.Lang -}}
            {{- $targetURL := "/" -}}
            {{- if ne .Lang $.Site.Language.Lang -}}
              {{- $targetURL = printf "/%s/" .Lang -}}
            {{- end -}}
            {{- /* For 404 pages, link to the other language's 404 */ -}}
            {{- if $is404 -}}
              {{- if eq .Lang "en" -}}
                {{- $targetURL = "/404.html" -}}
              {{- else -}}
                {{- $targetURL = printf "/%s/404.html" .Lang -}}
              {{- end -}}
            {{- end -}}
            <a
              href="{{ $targetURL }}"
              class="language-option{{ if not $is404 }} language-option--fallback{{ end }}"
              lang="{{ .Lang }}"
              hreflang="{{ .Lang }}"
              {{ if not $is404 }}title="{{ i18n "also_on_homepage" }}"{{ end }}
            >
              <span class="language-radio" aria-hidden="true"></span>
              <span class="language-name">{{ .LanguageName }}</span>
              {{- if not $is404 -}}
              <span class="fallback-indicator">{{ i18n "to_homepage" }}</span>
              {{- end -}}
            </a>
          {{- end -}}
        {{- end -}}
      {{- end -}}
    </div>
  </div>
  <div class="language-overlay" hidden></div>
</div>
{{- end -}}

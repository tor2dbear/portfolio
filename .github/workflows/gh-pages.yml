name: CI & Preview

on:
  push:
    branches:
      - main
      - master
  pull_request:

concurrency:
  group: preview-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        if: github.ref == 'refs/heads/master'
        run: npm run lint

      - name: Run tests
        if: github.ref == 'refs/heads/master'
        run: npm test

      - name: Security audit
        if: github.ref == 'refs/heads/master'
        run: npm audit --audit-level=high
        continue-on-error: true

  preview:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master'
    env:
      # Use head_ref for PRs, ref_name for pushes
      PREVIEW_BRANCH: ${{ github.head_ref || github.ref_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "0.145.0"
          extended: true

      - name: Build
        run: hugo --minify --buildFuture --baseURL "https://tor2dbear.github.io/portfolio/preview/${{ env.PREVIEW_BRANCH }}/"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          destination_dir: preview/${{ env.PREVIEW_BRANCH }}
          keep_files: true

      - name: Wait for GitHub Pages deployment
        run: |
          URL="https://tor2dbear.github.io/portfolio/preview/${{ env.PREVIEW_BRANCH }}/"
          echo "Waiting for $URL to be available..."
          for i in {1..30}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
            if [ "$STATUS" = "200" ]; then
              echo "Page is available (attempt $i)"
              exit 0
            fi
            echo "Attempt $i: HTTP $STATUS, waiting 10s..."
            sleep 10
          done
          echo "Page not available after 30 attempts"
          exit 1

      - name: Find associated pull request
        id: find_pr
        uses: actions/github-script@v7
        with:
          script: |
            const branch = process.env.PREVIEW_BRANCH || '';
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: context.repo.owner + ':' + branch,
              state: 'open'
            });
            if (prs.length > 0) {
              core.setOutput('number', prs[0].number.toString());
              core.setOutput('found', 'true');
              console.log('Found PR #' + prs[0].number + ' for branch ' + branch);
            } else {
              core.setOutput('number', '');
              core.setOutput('found', 'false');
              console.log('No open PR found for branch ' + branch);
            }

      - name: Run Lighthouse CI
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            https://tor2dbear.github.io/portfolio/preview/${{ env.PREVIEW_BRANCH }}/
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: .github/lighthouse/lighthouserc.json

      - name: Format Lighthouse score with TODOs
        id: lighthouse_score
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = ${{ steps.lighthouse.outputs.manifest }};
            const links = ${{ steps.lighthouse.outputs.links }};
            const summary = results[0].summary;
            const formatScore = (score) => Math.round(score * 100);
            const emoji = (score) => score >= 0.9 ? 'ðŸŸ¢' : score >= 0.5 ? 'ðŸŸ ' : 'ðŸ”´';

            // Read the full Lighthouse report for detailed audits
            const lhrPath = results[0].jsonPath;
            let todos = [];

            try {
              const lhr = JSON.parse(fs.readFileSync(lhrPath, 'utf8'));
              const audits = lhr.audits;

              // Categories to check for improvement opportunities
              const categories = ['performance', 'accessibility', 'best-practices', 'seo'];

              for (const cat of categories) {
                const catData = lhr.categories[cat];
                if (!catData) continue;

                for (const auditRef of catData.auditRefs) {
                  const audit = audits[auditRef.id];
                  if (!audit) continue;

                  // Include audits that failed or have warnings (score < 0.9)
                  if (audit.score !== null && audit.score < 0.9 && audit.score !== 1) {
                    const priority = audit.score < 0.5 ? 'ðŸ”´' : 'ðŸŸ ';
                    // Skip audits that are not applicable or informational
                    if (audit.scoreDisplayMode === 'notApplicable' || audit.scoreDisplayMode === 'informative') continue;

                    todos.push({
                      priority,
                      category: cat,
                      title: audit.title,
                      score: Math.round(audit.score * 100)
                    });
                  }
                }
              }

              // Remove duplicates and sort by priority
              todos = [...new Map(todos.map(t => [t.title, t])).values()]
                .sort((a, b) => a.score - b.score)
                .slice(0, 10); // Limit to top 10 issues
            } catch (e) {
              console.log('Could not parse LHR for TODOs:', e.message);
            }

            const scores = {
              performance: formatScore(summary.performance),
              accessibility: formatScore(summary.accessibility),
              bestPractices: formatScore(summary['best-practices']),
              seo: formatScore(summary.seo)
            };

            let todoSection = '';
            if (todos.length > 0) {
              todoSection = `\n\n**Improvement Opportunities:**\n`;
              for (const todo of todos) {
                todoSection += `- [ ] ${todo.priority} ${todo.title}\n`;
              }
            }

            const reportUrl = Object.values(links)[0] || results[0].htmlPath;
            const previewBranch = process.env.PREVIEW_BRANCH || '';
            const previewUrl = 'https://tor2dbear.github.io/portfolio/preview/' + previewBranch + '/';

            const comment = [
              'ðŸ” **Preview ready!**',
              '',
              previewUrl,
              '',
              '**Lighthouse Report:**',
              '| Category | Score |',
              '|----------|-------|',
              `| ${emoji(summary.performance)} Performance | ${scores.performance} |`,
              `| ${emoji(summary.accessibility)} Accessibility | ${scores.accessibility} |`,
              `| ${emoji(summary['best-practices'])} Best Practices | ${scores.bestPractices} |`,
              `| ${emoji(summary.seo)} SEO | ${scores.seo} |`,
              '',
              `[View full report](${reportUrl})${todoSection}`
            ].join('\n');

            core.setOutput('comment', comment);
            core.setOutput('todoSection', todoSection);
            core.setOutput('hasTodos', todos.length > 0 ? 'true' : 'false');
            core.setOutput('reportUrl', reportUrl);

      - name: Run axe accessibility scan
        id: axe
        run: |
          npm install -g @axe-core/cli
          URL="https://tor2dbear.github.io/portfolio/preview/${{ env.PREVIEW_BRANCH }}/"
          axe "$URL" --save axe-results.json --exit || true
          echo "Axe scan complete"

      - name: Process axe results
        id: axe_results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let violations = [];
            let axeSection = '';

            try {
              const results = JSON.parse(fs.readFileSync('axe-results.json', 'utf8'));
              violations = results[0]?.violations || [];

              if (violations.length > 0) {
                axeSection = '\n\n**Axe Accessibility Issues:**\n';
                for (const v of violations.slice(0, 10)) {
                  const impact = v.impact === 'critical' ? 'ðŸ”´' : v.impact === 'serious' ? 'ðŸŸ ' : 'ðŸŸ¡';
                  axeSection += '- [ ] ' + impact + ' ' + v.help + ' (' + v.nodes.length + ' elements)\n';
                }
              }
            } catch (e) {
              console.log('Could not parse axe results:', e.message);
            }

            core.setOutput('section', axeSection);
            core.setOutput('count', violations.length.toString());
            core.setOutput('hasViolations', violations.length > 0 ? 'true' : 'false');

      - name: Create accessibility issue if needed
        if: steps.find_pr.outputs.found == 'true' && steps.axe_results.outputs.hasViolations == 'true'
        uses: actions/github-script@v7
        env:
          AXE_SECTION: ${{ steps.axe_results.outputs.section }}
          AXE_COUNT: ${{ steps.axe_results.outputs.count }}
        with:
          script: |
            const fs = require('fs');
            const branch = process.env.PREVIEW_BRANCH || context.ref.replace('refs/heads/', '');
            const previewUrl = 'https://tor2dbear.github.io/portfolio/preview/' + branch + '/';

            let details = '';
            try {
              const results = JSON.parse(fs.readFileSync('axe-results.json', 'utf8'));
              const violations = results[0]?.violations || [];
              for (const v of violations) {
                details += '\n### ' + v.help + '\n';
                details += '**Impact:** ' + v.impact + ' | **WCAG:** ' + (v.tags.filter(t => t.startsWith('wcag')).join(', ') || 'n/a') + '\n\n';
                details += v.description + '\n\n';
                details += '**Affected elements:**\n';
                for (const node of v.nodes.slice(0, 3)) {
                  details += '```html\n' + node.html + '\n```\n';
                }
                if (v.nodes.length > 3) {
                  details += '...and ' + (v.nodes.length - 3) + ' more elements\n';
                }
              }
            } catch (e) {
              details = 'Could not parse detailed results.';
            }

            const body = [
              'Axe accessibility scan found **' + process.env.AXE_COUNT + ' issues** on branch `' + branch + '`.',
              '',
              'Preview: ' + previewUrl,
              '',
              '## Issues Found',
              process.env.AXE_SECTION,
              '',
              '## Details',
              details
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Accessibility issues: ' + branch,
              body: body,
              labels: ['accessibility', 'automated']
            })

      - name: Create Lighthouse issue if needed
        if: steps.find_pr.outputs.found == 'true' && steps.lighthouse_score.outputs.hasTodos == 'true'
        uses: actions/github-script@v7
        env:
          TODO_SECTION: ${{ steps.lighthouse_score.outputs.todoSection }}
          REPORT_URL: ${{ steps.lighthouse_score.outputs.reportUrl }}
        with:
          script: |
            const branch = process.env.PREVIEW_BRANCH || context.ref.replace('refs/heads/', '');
            const previewUrl = 'https://tor2dbear.github.io/portfolio/preview/' + branch + '/';
            const reportUrl = process.env.REPORT_URL || '';
            const todoSection = process.env.TODO_SECTION || '';

            const body = [
              'Lighthouse audit found improvement opportunities on branch `' + branch + '`.',
              '',
              'Preview: ' + previewUrl,
              '',
              'Full report: ' + reportUrl,
              '',
              '## Improvement Opportunities',
              todoSection
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Lighthouse improvements: ' + branch,
              body: body,
              labels: ['performance', 'automated']
            })

      - name: Check for broken links
        id: lychee
        uses: lycheeverse/lychee-action@v2
        with:
          args: >-
            --base https://tor2dbear.github.io/portfolio/preview/${{ env.PREVIEW_BRANCH }}/
            --exclude-loopback
            --exclude-mail
            --accept 200,204,301,302,307,308
            --timeout 30
            --max-retries 3
            ./public
          output: lychee-results.md
          fail: false

      - name: Process broken links
        id: broken_links
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let brokenLinks = [];
            let linkSection = '';

            try {
              const results = fs.readFileSync('lychee-results.md', 'utf8');
              const lines = results.split('\n');

              for (const line of lines) {
                if (line.includes('[ERR]') || line.includes('[FAIL]')) {
                  brokenLinks.push(line.trim());
                }
              }

              if (brokenLinks.length > 0) {
                linkSection = '\n\n**Broken Links Found:**\n';
                for (const link of brokenLinks.slice(0, 15)) {
                  linkSection += '- ' + link + '\n';
                }
                if (brokenLinks.length > 15) {
                  linkSection += '...and ' + (brokenLinks.length - 15) + ' more\n';
                }
              }
            } catch (e) {
              console.log('Could not parse lychee results:', e.message);
            }

            core.setOutput('section', linkSection);
            core.setOutput('count', brokenLinks.length.toString());
            core.setOutput('hasBrokenLinks', brokenLinks.length > 0 ? 'true' : 'false');

      - name: Comment on PR with all results
        if: steps.find_pr.outputs.found == 'true'
        uses: actions/github-script@v7
        env:
          COMMENT_BODY: ${{ steps.lighthouse_score.outputs.comment }}
          AXE_SECTION: ${{ steps.axe_results.outputs.section }}
          LINK_SECTION: ${{ steps.broken_links.outputs.section }}
          PR_NUMBER: ${{ steps.find_pr.outputs.number }}
        with:
          script: |
            const body = process.env.COMMENT_BODY + (process.env.AXE_SECTION || '') + (process.env.LINK_SECTION || '');
            await github.rest.issues.createComment({
              issue_number: parseInt(process.env.PR_NUMBER),
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

      - name: Request Codex review
        if: steps.find_pr.outputs.found == 'true'
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.find_pr.outputs.number }}
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: parseInt(process.env.PR_NUMBER),
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '@codex review'
            })

      - name: Create broken links issue if needed
        if: steps.find_pr.outputs.found == 'true' && steps.broken_links.outputs.hasBrokenLinks == 'true'
        uses: actions/github-script@v7
        env:
          LINK_COUNT: ${{ steps.broken_links.outputs.count }}
        with:
          script: |
            const fs = require('fs');
            const branch = process.env.PREVIEW_BRANCH || context.ref.replace('refs/heads/', '');
            const previewUrl = 'https://tor2dbear.github.io/portfolio/preview/' + branch + '/';

            let details = '';
            try {
              details = fs.readFileSync('lychee-results.md', 'utf8');
            } catch (e) {
              details = 'Could not read detailed results.';
            }

            const body = [
              'Link checker found **' + process.env.LINK_COUNT + ' broken links** on branch `' + branch + '`.',
              '',
              'Preview: ' + previewUrl,
              '',
              '## Details',
              '```',
              details,
              '```'
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Broken links: ' + branch,
              body: body,
              labels: ['broken-links', 'automated']
            })
